
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mes Recettes</title>

<!-- (Ta police d'origine ; si elle ne charge pas, c'est normal: Proxima Nova n'est pas sur Google Fonts) -->
<link href="https://fonts.googleapis.com/css2?family=Proxima+Nova:wght@400;600&display=swap" rel="stylesheet">

<style>
  body { font-family:'Proxima Nova',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; padding:10px; background:#e8f5e9; margin:0; }
  header { background:#4caf50; color:white; text-align:center; padding:1rem; font-size:1.5rem; font-weight:600; border-radius:0 0 10px 10px; }
  main { padding:1rem; }
  .recipe { background:white; padding:10px; margin-bottom:10px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  .category { font-size:12px; color:#388e3c; text-transform:uppercase; display:block; margin-bottom:5px; font-weight:600; }
  form input, form select, form button { width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #c8e6c9; box-sizing:border-box; }
  form button { background:#66bb6a; color:white; border:none; cursor:pointer; font-weight:600; }
  form button:hover { background:#388e3c; }
  button { cursor:pointer; margin-right:5px; border-radius:5px; padding:5px 10px; font-weight:600; border:none; }
  button.edit { background:#a5d6a7; color:#1b5e20; }
  button.delete { background:#c8e6c9; color:#2e7d32; }
  .filter-group { margin-bottom:10px; }
  .muted { opacity:.7; font-size:.95rem; }
  .bar { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .error { background:#ffdddd; color:#8b0000; border:1px solid #8b000088; padding:.5rem .75rem; border-radius:6px; display:none; }
  .ok { background:#ddffdd; color:#006400; border:1px solid #00640088; padding:.5rem .75rem; border-radius:6px; display:none; }
</style>
</head>

<body>
<header>Mes Recettes ðŸŒ¿</header>
<main>

  <!-- Messages -->
  <div class="bar">
    <button id="refreshBtn">ðŸ”„ RafraÃ®chir</button>
    <span id="count" class="muted"></span>
  </div>
  <div id="errorBox" class="error"></div>
  <div id="okBox" class="ok"></div>

  <!-- Formulaire -->
  <form id="recipeForm">
    <input type="text" id="title" placeholder="Nom de la recette" required />
    <input type="url" id="url" placeholder="Lien de la recette" required />
    <select id="category" required>
      <option value="">Choisir une catÃ©gorie</option>
      <option value="entree">EntrÃ©e</option>
      <option value="plat">Plat</option>
      <option value="dessert">Dessert</option>
    </select>
    <label style="display:block; margin-bottom:10px;">
      <input type="checkbox" id="vegan" /> ðŸŒ¿ VÃ©gÃ©tale
    </label>
    <button type="submit">Ajouter la recette</button>
  </form>

  <!-- Filtres -->
  <div class="filter-group">
    <label>Filtrer par catÃ©gorie :</label>
    <select id="filterCategory">
      <option value="all">Toutes</option>
      <option value="entree">EntrÃ©e</option>
      <option value="plat">Plat</option>
      <option value="dessert">Dessert</option>
    </select>
    <label style="display:block; margin-top:5px;">
      <input type="checkbox" id="filterVegan" /> Afficher seulement ðŸŒ¿ VÃ©gÃ©tales
    </label>
  </div>

  <!-- Liste -->
  <div id="recipesContainer"></div>

  <!-- Script -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // ðŸ”§ REMPLACER CES CONSTANTES
    const SUPABASE_URL = 'https://yztzhfwzscskusiccpov.supabase.co'
    const SUPABASE_ANON_KEY = 'sb_publishable_Sd0Ut3CDYKr4g8FhMKcHcg_BrRaTBfY'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    // UI refs
    const container = document.getElementById('recipesContainer')
    const form = document.getElementById('recipeForm')
    const filterSelect = document.getElementById('filterCategory')
    const filterVeganCheckbox = document.getElementById('filterVegan')
    const refreshBtn = document.getElementById('refreshBtn')
    const count = document.getElementById('count')
    const errorBox = document.getElementById('errorBox')
    const okBox = document.getElementById('okBox')

    let recipes = []       // cache local depuis la DB
    let editingId = null   // si non null -> on est en mode Ã©dition

    // Helpers
    const showError = (msg) => { errorBox.textContent = msg; errorBox.style.display='block'; okBox.style.display='none' }
    const showOk = (msg) => { okBox.textContent = msg; okBox.style.display='block'; errorBox.style.display='none' }
    const clearAlerts = () => { errorBox.style.display='none'; okBox.style.display='none' }

    // Charger depuis Supabase
    async function loadRecipes() {
      clearAlerts()
      container.innerHTML = '<p class="muted">Chargementâ€¦</p>'
      const { data, error } = await supabase
        .from('recettes')
        .select('id, title, url, category, vegan, created_at')
        .order('title', { ascending: true })

      if (error) {
        container.innerHTML = ''
        showError('Erreur de chargement : ' + (error.message || JSON.stringify(error)))
        return
      }
      recipes = data || []
      renderRecipes()
    }

    // Rendu local (avec filtres)
    function renderRecipes() {
      const selectedCategory = filterSelect.value
      const onlyVegan = filterVeganCheckbox.checked

      const filtered = recipes.filter(r => {
        if (selectedCategory !== 'all' && r.category !== selectedCategory) return false
        if (onlyVegan && !r.vegan) return false
        return true
      })

      count.textContent = filtered.length ? `${filtered.length} recette(s)` : 'Aucune recette'
      container.innerHTML = ''

      if (!filtered.length) {
        container.innerHTML = '<p class="muted">Aucune recette ne correspond au filtre.</p>'
        return
      }

      for (const r of filtered) {
        const div = document.createElement('div')
        div.className = 'recettes'
        div.innerHTML = `
          <h2>${escapeHtml(r.title)} ${r.vegan ? 'ðŸŒ¿' : ''}</h2>
          <span class="category">${escapeHtml(r.category)}</span>
          <a href="${escapeAttr(r.url)}" target="_blank" rel="noopener noreferrer">Voir la recette</a>
          <div style="margin-top:5px;">
            <button class="edit" data-id="${r.id}">Modifier</button>
            <button class="delete" data-id="${r.id}">Supprimer</button>
          </div>
        `
        div.querySelector('.edit').addEventListener('click', () => editRecipe(r.id))
        div.querySelector('.delete').addEventListener('click', () => deleteRecipe(r.id, r.title))
        container.appendChild(div)
      }
    }

    // Ajouter ou mettre Ã  jour selon l'Ã©tat
    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      clearAlerts()

      const title = document.getElementById('title').value.trim()
      const url = document.getElementById('url').value.trim()
      const category = document.getElementById('category').value
      const vegan = document.getElementById('vegan').checked

      if (!title || !url || !category) {
        showError('Veuillez remplir tous les champs obligatoires.')
        return
      }

      if (editingId) {
        // UPDATE
        const { error } = await supabase
          .from('recettes')
          .update({ title, url, category, vegan })
          .eq('id', editingId)

        if (error) return showError('Erreur mise Ã  jour : ' + (error.message || JSON.stringify(error)))
        showOk('Recette mise Ã  jour âœ…')
        editingId = null
        form.querySelector('button[type="submit"]').textContent = 'Ajouter la recette'
      } else {
        // INSERT
        const { error } = await supabase
          .from('recettes')
          .insert({ title, url, category, vegan })
        if (error) return showError('Erreur ajout : ' + (error.message || JSON.stringify(error)))
        showOk('Recette ajoutÃ©e âœ…')
      }

      form.reset()
      await loadRecipes()
    })

    // PrÃ©-remplir le formulaire pour Ã©dition
    function editRecipe(id) {
      const r = recipes.find(x => x.id === id)
      if (!r) return
      document.getElementById('title').value = r.title
      document.getElementById('url').value = r.url
      document.getElementById('category').value = r.category
      document.getElementById('vegan').checked = !!r.vegan
      editingId = id
      form.querySelector('button[type="submit"]').textContent = 'Mettre Ã  jour'
      clearAlerts()
    }

    // Supprimer
    async function deleteRecipe(id, title='') {
      clearAlerts()
      if (!confirm(`Supprimer Â« ${title || 'cette recette'} Â» ?`)) return
      const { error } = await supabase.from('recettes').delete().eq('id', id)
      if (error) return showError('Erreur suppression : ' + (error.message || JSON.stringify(error)))
      showOk('Recette supprimÃ©e âœ…')
      await loadRecipes()
    }

    // Filtres & refresh
    filterSelect.addEventListener('change', renderRecipes)
    filterVeganCheckbox.addEventListener('change', renderRecipes)
    document.getElementById('refreshBtn').addEventListener('click', loadRecipes)

    // SÃ©curitÃ© minimale : Ã©chapper ce qui vient de la DB (XSS)
    function escapeHtml(s='') { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])) }
    function escapeAttr(s='') { return escapeHtml(s).replace(/"/g, '&quot;') }

    // Premier chargement
    loadRecipes()
  </script>
</main>
</body>
</html>

